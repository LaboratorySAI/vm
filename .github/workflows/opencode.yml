name: OpenChamber + OpenCode (Antigravity)

on:
  workflow_dispatch:

jobs:
  serve:
    runs-on: ubuntu-latest
    steps:

      # 1Ô∏è‚É£ Checkout
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 3Ô∏è‚É£ Try restoring creds (NON-FAIL)
      - name: Restore OpenCode credentials (if exists)
        id: restore-creds
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: opencode-creds
          path: ~/.local/share/opencode/

      # 4Ô∏è‚É£ Install OpenCode + Antigravity plugin
      - name: Install OpenCode + Antigravity
        run: |
          npm install -g opencode-ai
          mkdir -p ~/.config/opencode

          cat << 'EOF' > ~/.config/opencode/opencode.json
          {
            "$schema": "https://opencode.ai/config.json",
            "plugin": ["opencode-antigravity-auth@1.2.8"],
            "provider": {
              "google": {
                "models": {
                  "antigravity-gemini-3-pro-low": {
                    "name": "Gemini 3 Pro Low (Antigravity)",
                    "limit": { "context": 1048576, "output": 65535 },
                    "modalities": { "input": ["text","image","pdf"], "output": ["text"] }
                  },
                  "antigravity-gemini-3-pro-high": {
                    "name": "Gemini 3 Pro High (Antigravity)",
                    "limit": { "context": 1048576, "output": 65535 },
                    "modalities": { "input": ["text","image","pdf"], "output": ["text"] }
                  }
                }
              }
            }
          }
          EOF

      # 5Ô∏è‚É£ Install OpenChamber
      - name: Install OpenChamber
        run: |
          npm install -g @openchamber/web

      # 6Ô∏è‚É£ Start OpenCode backend
      - name: Start OpenCode
        run: |
          nohup opencode web --port 8080 &
          sleep 12

      # 7Ô∏è‚É£ Start OpenChamber UI
      - name: Start OpenChamber
        run: |
          nohup openchamber --port 9090 &
          sleep 12

      # 8Ô∏è‚É£ Expose with ngrok
      - name: Start ngrok
        uses: luisboto/ngrok-tunnel-action@v0.1.7.2
        with:
          ngrok_authtoken: ${{ secrets.NGROK_AUTHTOKEN }}
          port: 9090
          tunnel_type: http
          save_url_to_filename: tunnel-url.txt

      # 9Ô∏è‚É£ Show URL
      - name: Show public URL
        run: cat tunnel-url.txt

      # üîü Save URL artifact
      - name: Save tunnel URL
        uses: actions/upload-artifact@v4
        with:
          name: openchamber-url
          path: tunnel-url.txt

      # 1Ô∏è‚É£1Ô∏è‚É£ Save creds (ALWAYS)
      - name: Save OpenCode credentials
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: opencode-creds
          path: ~/.local/share/opencode/
          retention-days: 30