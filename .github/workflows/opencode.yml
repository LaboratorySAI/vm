name: OpenChamber + OpenCode (Antigravity)

on:
  workflow_dispatch:

jobs:
  serve:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Restore OpenCode Session
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: opencode-creds
          path: /home/runner/.local/share/opencode/

      - name: Install OpenCode + Antigravity
        run: |
          npm install -g opencode-ai
          mkdir -p ~/.config/opencode
          cat << 'EOF' > ~/.config/opencode/opencode.json
          {
            "$schema": "https://opencode.ai/config.json",
            "plugin": ["opencode-antigravity-auth@1.2.8"],
            "provider": {
              "google": {
                "models": {
                  "antigravity-gemini-3-pro-low": {
                    "name": "Gemini 3 Pro Low (Antigravity)",
                    "limit": { "context": 1048576, "output": 65535 },
                    "modalities": { "input": ["text","image","pdf"], "output": ["text"] }
                  },
                  "antigravity-gemini-3-pro-high": {
                    "name": "Gemini 3 Pro High (Antigravity)",
                    "limit": { "context": 1048576, "output": 65535 },
                    "modalities": { "input": ["text","image","pdf"], "output": ["text"] }
                  }
                }
              }
            }
          }
          EOF

      - name: Install OpenChamber
        run: npm install -g @openchamber/web

      - name: Start Services
        run: |
          # Removed the --host flag which caused the crash. 
          # Most Node apps use the HOST env variable instead.
          export HOST=0.0.0.0
          nohup opencode web --port 8080 > opencode.log 2>&1 &
          nohup openchamber --port 9090 > openchamber.log 2>&1 &
          
          echo "Waiting for services to boot..."
          # Increased sleep to give the background processes more time
          sleep 15
          
          # Simplified health check
          if lsof -Pi :9090 -sTCP:LISTEN -t >/dev/null ; then
              echo "OpenChamber is UP on port 9090."
          else
              echo "OpenChamber failed to start. Logs below:"
              cat openchamber.log
              exit 1
          fi

      - name: Setup ngrok
        env:
          NGROK_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update && sudo apt install ngrok -y
          ngrok config add-authtoken "$NGROK_TOKEN"

      - name: Start ngrok Tunnel
        run: |
          # Use 127.0.0.1 explicitly to bypass IPv6 loopback issues
          nohup ngrok http 127.0.0.1:9090 --log=stdout > ngrok.log 2>&1 &
          sleep 10
          PUBLIC_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          echo "URL=$PUBLIC_URL" >> $GITHUB_ENV
          echo "------------------------------------------"
          echo "TUNNEL LIVE AT: $PUBLIC_URL"
          echo "------------------------------------------"

      - name: Keep Alive (6 Hours)
        run: |
          echo "Public URL: ${{ env.URL }}"
          sleep 21600

      - name: Save OpenCode Session
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: opencode-creds
          path: /home/runner/.local/share/opencode/
          retention-days: 30
