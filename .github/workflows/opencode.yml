name: OpenChamber + OpenCode (Antigravity)

on:
  workflow_dispatch:
    inputs:
      tunnel_provider:
        description: 'Select Tunnel Provider'
        required: true
        default: 'cloudflare'
        type: choice
        options:
          - ngrok
          - cloudflare

jobs:
  serve:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Tools
        run: |
          npm install -g opencode-ai @openchamber/web
          sudo apt update
          sudo apt install jq lsof coreutils -y 

      - name: Configure OpenCode (Antigravity)
        run: |
          mkdir -p ~/.config/opencode
          cat << 'EOF' > ~/.config/opencode/opencode.json
          {
            "$schema": "https://opencode.ai/config.json",
            "plugin": ["opencode-antigravity-auth@1.2.8"],
            "provider": {
              "google": {
                "models": {
                  "antigravity-gemini-3-pro-low": { "name": "Gemini 3 Pro Low (Antigravity)", "limit": { "context": 1048576, "output": 65535 }, "modalities": { "input": ["text","image","pdf"], "output": ["text"] } },
                  "antigravity-gemini-3-pro-high": { "name": "Gemini 3 Pro High (Antigravity)", "limit": { "context": 1048576, "output": 65535 }, "modalities": { "input": ["text","image","pdf"], "output": ["text"] } },
                  "antigravity-gemini-3-flash": { "name": "Gemini 3 Flash (Antigravity)", "limit": { "context": 1048576, "output": 65535 }, "modalities": { "input": ["text","image","pdf"], "output": ["text"] } },
                  "antigravity-gemini-ultra": { "name": "Gemini Ultra (Antigravity)", "limit": { "context": 1048576, "output": 65535 }, "modalities": { "input": ["text","image","pdf"], "output": ["text"] } }
                }
              }
            }
          }
          EOF

      - name: Initial Startup
        run: |
          nohup stdbuf -oL opencode web --port 8080 > opencode.log 2>&1 &
          nohup stdbuf -oL openchamber --port 9090 > openchamber.log 2>&1 &
          sleep 20
          
          if [[ "${{ github.event.inputs.tunnel_provider }}" == "ngrok" ]]; then
            curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
            echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
            sudo apt update && sudo apt install ngrok -y
            ngrok config add-authtoken "${{ secrets.NGROK_AUTH_TOKEN }}"
            nohup ngrok http 127.0.0.1:9090 --log=stdout > tunnel.log 2>&1 &
            sleep 10
            echo "URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')" >> $GITHUB_ENV
          else
            wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
            sudo dpkg -i cloudflared-linux-amd64.deb
            nohup cloudflared tunnel --url http://127.0.0.1:9090 > tunnel.log 2>&1 &
            sleep 15
            echo "URL=$(grep -o 'https://[-a-z0-9.]*trycloudflare.com' tunnel.log | tail -n 1)" >> $GITHUB_ENV
          fi

      - name: Monitor & Self-Heal Website
        run: |
          echo "------------------------------------------"
          echo "SERVER LIVE AT: ${{ env.URL }}"
          echo "Monitoring for crashes..."
          echo "------------------------------------------"
          
          while true; do
            # 1. WEBSITE CRASH CHECK: If port 9090 is dead, restart OpenChamber
            if ! lsof -i :9090 > /dev/null; then
              echo "[$(date)] !!! WEBSITE CRASH DETECTED !!! Restarting OpenChamber..."
              nohup stdbuf -oL openchamber --port 9090 >> openchamber.log 2>&1 &
              sleep 10
              # Verify restart
              if lsof -i :9090 > /dev/null; then
                echo "[$(date)] Website successfully restored."
              fi
            fi

            # 2. TUNNEL CRASH CHECK: If tunnel process is dead, rehost with a new link
            if ! pgrep -f "ngrok|cloudflared" > /dev/null; then
              echo "[$(date)] !!! TUNNEL CRASH DETECTED !!! Rehosting..."
              if [[ "${{ github.event.inputs.tunnel_provider }}" == "ngrok" ]]; then
                nohup ngrok http 127.0.0.1:9090 --log=stdout > tunnel.log 2>&1 &
                sleep 10
                URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
              else
                nohup cloudflared tunnel --url http://127.0.0.1:9090 > tunnel.log 2>&1 &
                sleep 15
                URL=$(grep -o 'https://[-a-z0-9.]*trycloudflare.com' tunnel.log | tail -n 1)
              fi
              echo "------------------------------------------"
              echo "NEW TUNNEL LINK: $URL"
              echo "------------------------------------------"
            fi
            
            # Keep log active in GitHub console
            tail -n 1 openchamber.log
            sleep 10
          done
